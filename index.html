
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de Pensiones</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 40px; background: #f0f0f0; }
    button { font-size: 18px; margin: 15px; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; }
    #log, #historial { margin-top: 20px; font-size: 18px; color: #333; }
    table { width: 100%; max-width: 700px; margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCNvsDzT9QH8IDpLN2Obn2S6UxIzY-R9Ro",
      authDomain: "control-de-pensiones-e59cc.firebaseapp.com",
      databaseURL: "https://control-de-pensiones-e59cc-default-rtdb.firebaseio.com",
      projectId: "control-de-pensiones-e59cc",
      storageBucket: "control-de-pensiones-e59cc.appspot.com",
      messagingSenderId: "1016730020594",
      appId: "1:1016730020594:web:104ca6485404cf83d3fe6b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const pagosRef = ref(db, "pagos");

    const mesesDelA침o = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
    const anioBase = 2025;

    function obtenerMesActual() {
      const hoy = new Date();
      return hoy.getMonth(); // 0-indexed
    }

    function obtenerFechaHoy() {
      return new Date().toISOString().split("T")[0]; // yyyy-mm-dd
    }

    function obtenerMesesHastaHoy() {
      const mesHoy = obtenerMesActual();
      return mesesDelA침o.slice(0, mesHoy + 1);
    }

    function hablar(texto) {
      const voz = new SpeechSynthesisUtterance(texto);
      voz.lang = "es-ES";
      speechSynthesis.speak(voz);
    }

    window.registrarPago = () => {
      const reconocimiento = new webkitSpeechRecognition();
      reconocimiento.lang = 'es-ES';
      reconocimiento.onresult = (event) => {
        const frase = event.results[0][0].transcript;
        const fecha = new Date().toLocaleDateString("es-ES");

        onValue(pagosRef, (snapshot) => {
          const datos = snapshot.val() || {};
          const yaPagados = Object.values(datos).map(p => p.mes);
          const todos = obtenerMesesHastaHoy();
          const pendientes = todos.filter(m => !yaPagados.includes(m));

          if (pendientes.length === 0) {
            const mensaje = "Actualmente tus pagos est치n al d칤a.";
            document.getElementById("log").innerText = mensaje;
            hablar(mensaje);
            return;
          }

          const siguienteMes = pendientes[0];
          push(pagosRef, { fecha: fecha, nota: frase, mes: siguienteMes });
          const mensaje = `Pago registrado el ${fecha}. Se asign칩 al mes de ${siguienteMes}.`;
          document.getElementById("log").innerText = mensaje;
          hablar(mensaje);
          mostrarHistorial();
        }, { onlyOnce: true });
      };
      reconocimiento.start();
    };

    window.verEstado = () => {
      onValue(pagosRef, (snapshot) => {
        const datos = snapshot.val();
        if (!datos) {
          hablar("No hay pagos registrados todav칤a.");
          return;
        }
        const pagos = Object.values(datos);
        const yaPagados = pagos.map(p => p.mes);
        const todos = obtenerMesesHastaHoy();
        const faltantes = todos.filter(m => !yaPagados.includes(m));
        const ultimo = pagos[pagos.length - 1];

        let mensaje = `Se han registrado ${pagos.length} pagos. El 칰ltimo fue el ${ultimo.fecha} y se asign칩 al mes de ${ultimo.mes}. `;
        mensaje += faltantes.length === 0 ? "Actualmente tus pagos est치n al d칤a." : `Actualmente tienes ${faltantes.length} meses pendientes.`;

        document.getElementById("log").innerText = mensaje;
        hablar(mensaje);
      }, { onlyOnce: true });
    };

    window.exportarExcel = () => {
      onValue(pagosRef, (snapshot) => {
        const datos = snapshot.val() || {};
        const pagos = Object.values(datos);
        const yaPagados = pagos.map(p => p.mes);
        const todos = obtenerMesesHastaHoy();
        const pendientes = todos.filter(m => !yaPagados.includes(m));

        const exportData = pagos.map(p => {
          return {
            "FECHA DE PAGO": p.fecha,
            "MES APLICADO": `${p.mes} ${anioBase}`,
            "MESES PENDIENTES": pendientes.length ? pendientes.map(m => `${m} ${anioBase}`).join(" / ") : "sin meses pendientes"
          };
        });

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Historial");
        XLSX.writeFile(wb, `historial_${obtenerFechaHoy()}.xlsx`);
      }, { onlyOnce: true });
    };

    window.mostrarHistorial = () => {
      onValue(pagosRef, (snapshot) => {
        const datos = snapshot.val() || {};
        const pagos = Object.values(datos);
        const yaPagados = pagos.map(p => p.mes);
        const todos = obtenerMesesHastaHoy();
        const pendientes = todos.filter(m => !yaPagados.includes(m));

        const contenedor = document.getElementById("historial");
        contenedor.innerHTML = "";

        const tabla = document.createElement("table");
        tabla.innerHTML = "<tr><th>Fecha</th><th>Mes</th><th>Nota</th></tr>";

        pagos.forEach(pago => {
          const fila = document.createElement("tr");
          fila.innerHTML = `<td>${pago.fecha}</td><td>${pago.mes}</td><td>${pago.nota}</td>`;
          tabla.appendChild(fila);
        });

        pendientes.forEach(m => {
          const fila = document.createElement("tr");
          fila.innerHTML = `<td>-</td><td>${m} ${anioBase}</td><td>-</td>`;
          tabla.appendChild(fila);
        });

        contenedor.appendChild(tabla);
      }, { onlyOnce: true });
    };

    window.onload = mostrarHistorial;
  </script>
</head>
<body>
  <h1>Control de Pensiones</h1>
  <button onclick="registrarPago()">Registrar Pago</button>
  <button onclick="verEstado()">Ver Estado</button>
  <button onclick="exportarExcel()">游늯 Exportar pagos a Excel</button>
  <div id="log"></div>
  <div id="historial"></div>
</body>
</html>
