
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Pensiones</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" />
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; text-align: center; }
    h1 { background: #2c3e50; color: white; padding: 1rem; }
    button {
      margin: 10px; padding: 15px 25px; font-size: 18px; border: none; border-radius: 10px; color: white; width: 80%;
      max-width: 400px; animation: pulse 2s infinite; cursor: pointer;
    }
    .registrar { background-color: #3498db; }
    .estado { background-color: #2ecc71; }
    .exportar { background-color: #95a5a6; animation: none; }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.85; }
      100% { transform: scale(1); opacity: 1; }
    }
    table { margin: 20px auto; width: 90%; max-width: 600px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; background: white; }
    #log, #historial { font-size: 16px; margin: 15px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCNvsDzT9QH8IDpLN2Obn2S6UxIzY-R9Ro",
      authDomain: "control-de-pensiones-e59cc.firebaseapp.com",
      databaseURL: "https://control-de-pensiones-e59cc-default-rtdb.firebaseio.com",
      projectId: "control-de-pensiones-e59cc",
      storageBucket: "control-de-pensiones-e59cc.appspot.com",
      messagingSenderId: "1016730020594",
      appId: "1:1016730020594:web:104ca6485404cf83d3fe6b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const pagosRef = ref(db, "pagos");

    const mesesBase = ["DICIEMBRE", "ENERO", "FEBRERO", "MARZO", "ABRIL"];
    const anioBase = 2024;
    const anio2025 = 2025;

    function hablar(texto) {
      const voz = new SpeechSynthesisUtterance(texto);
      voz.lang = "es-ES";
      speechSynthesis.speak(voz);
    }

    window.onload = () => {
      const audio = new SpeechSynthesisUtterance("Bienvenida. Para registrar un pago, toca el bot칩n azul. Para saber si est치s al d칤a, toca el bot칩n verde.");
      audio.lang = "es-ES";
      speechSynthesis.speak(audio);
    };

    window.registrarPago = () => {
      const reconocimiento = new webkitSpeechRecognition();
      reconocimiento.lang = 'es-ES';
      reconocimiento.onresult = (event) => {
        const frase = event.results[0][0].transcript;
        const fecha = new Date().toLocaleDateString("es-ES");

        onValue(pagosRef, (snapshot) => {
          const datos = snapshot.val() || {};
          const registrados = Object.values(datos).map(p => p.mes);
          const todos = mesesBase;
          const pendientes = todos.filter(m => !registrados.includes(m));

          if (pendientes.length === 0) {
            const mensaje = "Actualmente tus pagos est치n al d칤a.";
            document.getElementById("log").innerText = mensaje;
            hablar(mensaje);
            return;
          }

          const siguienteMes = pendientes[0];
          push(pagosRef, { fecha: fecha, nota: frase, mes: siguienteMes });
          const mensaje = `Pago registrado el ${fecha}. Se asign칩 al mes de ${siguienteMes}.`;
          document.getElementById("log").innerText = mensaje;
          hablar(mensaje);
          mostrarHistorial();
        }, { onlyOnce: true });
      };
      reconocimiento.start();
    };

    window.verEstado = () => {
      onValue(pagosRef, (snapshot) => {
        const datos = snapshot.val() || {};
        const pagos = Object.values(datos);
        if (!pagos.length) {
          hablar("A칰n no hay pagos registrados.");
          return;
        }

        const registrados = pagos.map(p => p.mes);
        const todos = mesesBase;
        const pendientes = todos.filter(m => !registrados.includes(m));
        const ultimo = pagos[pagos.length - 1];

        let mensaje = `Se han registrado ${pagos.length} pagos. El 칰ltimo fue el ${ultimo.fecha} y se asign칩 al mes de ${ultimo.mes}. `;
        mensaje += pendientes.length === 0 ? "Actualmente tus pagos est치n al d칤a." : `Actualmente tienes ${pendientes.length} meses pendientes.`;

        document.getElementById("log").innerText = mensaje;
        hablar(mensaje);
      }, { onlyOnce: true });
    };

    window.exportarExcel = () => {
      onValue(pagosRef, (snapshot) => {
        const datos = snapshot.val() || {};
        const pagos = Object.values(datos);
        const registrados = pagos.map(p => p.mes);
        const todos = mesesBase;
        const pendientes = todos.filter(m => !registrados.includes(m));

        const exportData = pagos.map(p => ({
          "FECHA DE PAGO": p.fecha,
          "MES APLICADO": `${p.mes} ${p.mes === "DICIEMBRE" ? anioBase : anio2025}`,
          "MESES PENDIENTES": pendientes.length ? pendientes.map(m => `${m} ${m === "DICIEMBRE" ? anioBase : anio2025}`).join(" / ") : "sin meses pendientes"
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Historial");
        XLSX.writeFile(wb, `historial_${new Date().toISOString().split("T")[0]}.xlsx`);
      }, { onlyOnce: true });
    };

    window.mostrarHistorial = () => {
      onValue(pagosRef, (snapshot) => {
        const datos = snapshot.val() || {};
        const pagos = Object.values(datos);
        const registrados = pagos.map(p => p.mes);
        const todos = mesesBase;
        const pendientes = todos.filter(m => !registrados.includes(m));

        const contenedor = document.getElementById("historial");
        contenedor.innerHTML = "";

        const tabla = document.createElement("table");
        tabla.innerHTML = "<tr><th>Fecha</th><th>Mes</th><th>Nota</th></tr>";

        pagos.forEach(pago => {
          const fila = document.createElement("tr");
          fila.innerHTML = `<td>${pago.fecha}</td><td>${pago.mes}</td><td>${pago.nota}</td>`;
          tabla.appendChild(fila);
        });

        pendientes.forEach(m => {
          const fila = document.createElement("tr");
          fila.innerHTML = `<td>-</td><td>${m} ${m === "DICIEMBRE" ? anioBase : anio2025}</td><td>-</td>`;
          tabla.appendChild(fila);
        });

        contenedor.appendChild(tabla);
      }, { onlyOnce: true });
    };

    window.onload = mostrarHistorial;
  </script>
</head>
<body>
  <h1>Mis Pensiones</h1>
  <button class="registrar" onclick="registrarPago()">Registrar Pago</button>
  <button class="estado" onclick="verEstado()">Ver Estado</button>
  <button class="exportar" onclick="exportarExcel()">游늯 Exportar pagos a Excel</button>
  <div id="log"></div>
  <div id="historial"></div>
</body>
</html>
